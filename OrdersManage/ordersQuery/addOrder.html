<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>编辑行政审批</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="../../plugins/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="../../css/global.css" media="all">
    <link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../css/table.css"/>
</head>

<body>
<div style="margin: 15px;">
    <fieldset class="layui-elem-field">
        <legend>新建订单</legend>

        <div class="layui-field-box">
            <div class="order-form-title" style="margin-top: 15px">用户信息</div>
            <table class="layui-table">
                <colgroup>
                    <col width="100">
                    <col>
                </colgroup>
                <tbody>
                <tr>
                    <td colspan="2">
                        <div class="layui-input-inline">
                            <input type="text" name="title" lay-verify="" maxlength="11" autocomplete="off"
                                   placeholder="请输入乐政号/电话号码搜索" class="layui-input self-form-input">

                        </div>
                        <button class="layui-btn" lay-submit="" lay-filter="searuser" style="margin:0!important">搜索
                        </button>
                    </td>
                </tr>
                <tr>
                    <th class="self-form-title">乐政号：</th>
                    <td>
                        <div class="layui-input-inline" id="lznumber">用户乐政号</div>
                    </td>
                </tr>
                <tr>
                    <th class="self-form-title">手机号：</th>
                    <td>
                        <div class="layui-input-inline" id="phonenumer">用户手机号</div>
                    </td>
                </tr>
                <tr>
                    <th class="self-form-title">昵称：</th>
                    <td>
                        <div class="layui-input-inline" id="nickname">用户昵称</div>
                    </td>
                </tr>

                <tr>
                    <th class="self-form-title">常驻地址:</th>
                    <td>
                        <div class="layui-input-inline" id="address">用户常驻地址</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="layui-field-box">
            <form class="layui-form" action="" id="orderQuery">
                <input type="hidden" name="downOrderUserid">

                <div class="order-form-title">编辑订单</div>
                <table class="layui-table">
                    <!--
                    <tr>
                        <th class="self-form-title">订单类型：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <select name="ordertype" lay-verify="required" lay-filter="ordertype">
                                        <option value="">—— 请选择 ——</option>
                                        <option value="0">政务审批</option>
                                        <option value="1">车管业务</option>
                                        <option value="2">出入境</option>
                                        <option value="3">企业服务</option>
                                    </select>
                                </div>
                            </div>
                        </td>
                    </tr>
                    -->
                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">基本信息</div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">预约客户：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="username" maxlength="50" lay-verify="required"
                                       autocomplete="off"
                                       placeholder="请输入预约客户" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">手机号码：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="uphonenumber" maxlength="11" lay-verify="required"
                                       autocomplete="off"
                                       placeholder="请输入客户手机号码" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">取件区域：</th>
                        <td>
                            <div class="layui-input-inline area">
                                <select name="officearea" lay-verify="required" lay-filter="areaname">
                                    <option value="">— 请选择办事区域 —</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">详细地址：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="officeaddress" lay-verify="required" autocomplete="off"
                                           placeholder="请输入详细地址" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">受理商家：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="marketername" lay-verify="" autocomplete="off"
                                       placeholder="请选择受理商家" class="layui-input self-form-input chooseStore" readonly>

                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">事项信息：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline area" id="areaid">
                                    <select name="areaid" lay-verify="required" lay-filter="areaid">
                                        <option value="">— 请选择区域 —</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline" id="departmentid">
                                    <select name="departmentid" lay-verify="required" lay-filter="departmentname">
                                        <option value="">— 请选择部门 —</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline" id="itemid">
                                    <select name="productid" lay-verify="required" lay-filter="itemname">
                                        <option value="">— 请选择事项 —</option>
                                    </select>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="shenfz" style="display: none">
                        <th class="self-form-title">身份证：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="idcardno" lay-verify="idcard|required"
                                       autocomplete="off"
                                       placeholder="请输入客户身份证" maxlength="18" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr id="tongxzh" style="display: none">
                        <th class="self-form-title">通行证号：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="passnumber" lay-verify="required"
                                       autocomplete="off"
                                       placeholder="请输入客户通行证号" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr id="shenfzdz" style="display: none">
                        <th class="self-form-title">身份证地址：</th>
                        <td>
                            <div class="layui-input-inline">
                                <input type="text" name="idcardaddress" lay-verify="required"
                                       autocomplete="off"
                                       placeholder="请输入客户身份证地址" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">留言</div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">留言：</th>
                        <td>
                            <div class="layui-input-inline">
                                 <textarea placeholder="选填，请留下用户的特殊情况" name="remarks" class="layui-textarea"
                                           style="width: 300px"></textarea>
                            </div>
                        </td>
                    </tr>

                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">送件方式</div>
                        </td>
                    </tr>
                    <tr class="layui-form-item2">
                        <td colspan="2" id="deliveryway">
                            <input type="radio" lay-filter="deliveryway" name="deliveryway" value="3" title="送件上门">
                            <input type="radio" lay-filter="deliveryway" name="deliveryway" value="2"
                                   title="EMS邮寄（仅对武侯区开放）" checked>
                        </td>
                    </tr>

                    <tr style="background-color:#f2f2f2">
                        <td colspan="2">
                            <div class="order-form-title">收件人信息</div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">收件人：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="addressee" lay-verify="" autocomplete="off"
                                           placeholder="请输入收件人" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">手机号码：</th>
                        <td>
                            <div class="layui-input-inline">
                                <div class="layui-input-inline" id="fixedstep">
                                    <input type="text" name="aphonenumber" maxlength="11" lay-verify=""
                                           autocomplete="off"
                                           placeholder="请输入收件人手机号码" class="layui-input self-form-input">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="self-form-title">收件区域：</th>
                        <td>
                            <div class="layui-input-inline area">
                                <select name="inboxarea" lay-verify="">
                                    <option value="">— 请选择收件区域 —</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th class="detail-title">详细地址：</th>
                        <td>
                            <div class="layui-input-block edit_box self-edit-margin">
                                <input type="text" name="inboxaddress" lay-verify="" autocomplete="off"
                                       placeholder="请输入详细地址" class="layui-input self-form-input">
                            </div>
                        </td>
                    </tr>
                </table>
                <div class="layui-btn-group self-btn-return">
                    <button class="layui-btn" lay-submit="" lay-filter="submit">提交</button>
                    <button class="layui-btn layui-btn-primary" type="reset" lay-filter="reset">重置</button>
                </div>
            </form>

        </div>
    </fieldset>
</div>

<script id="orderHandle" type="text/html">
    <tr>
        <th>事项名称：</th>
        <td>{{ d.title}}</td>
    </tr>
    <tr>
        <th>事项编号：</th>
        <td>{{ d.id}}</td>
    </tr>
    <tr>
        <th>服务主题：</th>
        <td>建筑类</td>
    </tr>
    <tr>
        <th>订单步骤：</th>
        <td>订单步骤一</td>
    </tr>
</script>

<script type="text/javascript" src="../../plugins/layui/layui.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>

<script>
    layui.use(['form', 'layedit', 'laydate', 'element', 'icheck', 'laypage', 'layer', 'laytpl', 'common', 'formInStorage'], function () {
        var form = layui.form(),
                layer = layui.layer,
                layedit = layui.layedit,
                laydate = layui.laydate,
                $ = layui.jquery,
                laytpl = layui.laytpl,
                element = layui.element(), //Tab的切换功能，切换事件监听等，需要依赖element模块
                laypage = layui.laypage,
                common = layui.common,
                formInStorage = layui.formInStorage,
                apiUrl = common.apiUrl,
                wuhou = 7,//武侯区区域id
                editIndex = layedit.build('LAY_demo_editor'), //创建一个编辑器
                serviceIndex = localStorage.getItem('serviceIndex'),
                orderID = common.getUrlParam("id"),
                layer = layui.layer;
        common.saveTabIndex('serviceIndex');
        // common.init();
        common.layTime(); //时间选择

        /*********************************************select下拉项start***********************************************/
        //区域下拉列表
        var dataArr = {"id": 0};
        var areaBig = common.getJsonData('api/bossApi/service/areaSearch', '', dataArr);
        $.each(areaBig.datalist, function (index, item) {
            $(".area select").append('<optgroup label="' + item.areaname + '" oid="' + item.areacode + '"></optgroup>');
            var dataArr = {"id": item.areacode};
            var areaSmall = common.getJsonData('api/bossApi/service/areaSearch', '', dataArr);
            for (var i = 0; i < areaSmall.datalist.length; i++) {
                $("optgroup[oid='" + item.areaid + "']").append('<option value="' + areaSmall.datalist[i].areaid + '">' + areaSmall.datalist[i].areaname + '</option>');
            }
        });
        form.render();
        //显示部门列表
        form.on('select(areaid)', function (data) {
            $("#departmentid select").html('<option value="">— 请选择部门 —</option>');
            $("#itemid select").html('<option value="">— 请选择事项 —</option>');
            var departmentList = common.getJsonData('api/bossApi/service/departmentSearchByAreaID', '', {"id": data.value});
            $.each(departmentList.datalist, function (index, item) {
                $("#departmentid select").append('<option value="' + item.departmentid + '">' + item.name + '</option>');
            });
            //只有“武侯区全区 和 其他区域的车管和出入境”才显示收件信息
            var deliverywayVal = $("#deliveryway").find(".layui-form-radioed").prev().val();
            if (data.value == wuhou && deliverywayVal == 2) {
                $('.layui-form-item2').nextAll().show();
            } else {
                $('.layui-form-item2').nextAll().hide()
            }
            form.render();
        });

        //监听部门列表
        $('.layui-form-item2').nextAll().hide();
        form.on('select(departmentname)', function (data) {
            $("#itemid select").html('<option value="">— 请选择事项 —</option>');
            var areaid = $("select[lay-filter='areaid']").val()
            var itemList = common.getJsonData('api/bossApi/service/approvalSearch', '', {
                "areaid": areaid,
                "departmentid": data.value,
                "page": 1
            });
            $.each(itemList.datalist, function (index, item) {
                $("#itemid select").append('<option value="' + item.id + '" title="' + item.title + '" slot="' + item.departmenttype + '">' + item.title + '</option>');
            });
            //只有“武侯区全区 和 其他区域的车管和出入境”才显示收件信息
            var areaid = $("select[name='areaid']").val();
            var deliverywayVal = $("#deliveryway").find(".layui-form-radioed").prev().val();
            if (areaid == wuhou && deliverywayVal == 2) {
                $('.layui-form-item2').nextAll().show();
            } else {
                $('.layui-form-item2').nextAll().hide()
            }
            form.render();
        });

        //监听事项列表 只有“武侯区全区 和 其他区域的车管和出入境”才显示收件信息
        form.on('select(itemname)', function (data) {
            var value = data.value;
            var oplist = $("#itemid option");
            for (var i = 0; i < oplist.length; i++) {
                var departmenttype = oplist.eq(i).attr("slot");
                var areaid = $("select[name='areaid']").val();
                //console.log(departmenttype);
                var deliverywayVal = $("#deliveryway").find(".layui-form-radioed").prev().val();
                //console.log(areaid)
                //console.log(deliverywayVal)
                if (areaid == wuhou) {
                    if (deliverywayVal == 2) {
                        $('.layui-form-item2').nextAll().show();
                    } else {
                        $('.layui-form-item2').nextAll().hide()
                    }
                } else {
                    if (departmenttype == '10' || departmenttype == '20') {
                        $('.layui-form-item2').nextAll().show();
                    } else {
                        $('.layui-form-item2').nextAll().hide()
                    }
                }
                // console.log(data) //根据事项列表的departtype来判断显示内容
                //控制显示： 车管业务（身份证，身份证地址）, 出入境（身份证，通行证号）

                if (departmenttype === '10') { //车管
                    $('#shenfz').show();
                    $('#shenfzdz').show();
                    $('#shenfzdz').find("input").attr("lay-verify","required");
                    $('#tongxzh').hide();
                    $('#tongxzh').find("input").removeAttr("lay-verify");
                } else if (departmenttype === '20') {
                    $('#shenfz').show();
                    $('#tongxzh').show();
                    $('#tongxzh').find("input").attr("lay-verify","required");
                    $('#shenfzdz').hide();
                    $('#shenfzdz').find("input").removeAttr("lay-verify");
                } else {
                    $('#shenfz').hide();
                    $('#shenfz').find("input").removeAttr("lay-verify");
                    $('#shenfzdz').hide();
                    $('#shenfzdz').find("input").removeAttr("lay-verify");
                    $('#tongxzh').hide();
                    $('#tongxzh').find("input").removeAttr("lay-verify");
                }
            }
        });

        //监听邮寄方式(1自取，2邮寄，3送货上门)
        form.on('radio(deliveryway)', function (data) {
            var deliverywayVal = data.value;
            var areaid = $("select[name='areaid']").val();
            if (areaid && areaid == wuhou) {
                if (deliverywayVal == 2) {
                    $('.layui-form-item2').nextAll().show();
                } else {
                    $('.layui-form-item2').nextAll().hide()
                }
            }
        });


        /*********************************************select下拉项end***********************************************/

            //避免input被刷新清空
        formInStorage.init({
            formElem: '#orderQuery',
            formSession: 'orderQuery'
        });

        $(document).on('click', '.chooseStore', function () {
            layer.open({
                type: 2,
                title: '选择受理商家',
                shadeClose: true,
                shade: 0.8,
                area: ['1200px', '90%'],
                content: '../ordersHandle/orderallot.html'
            });
        })

        //给受理商家input赋值
        var marketername = sessionStorage.getItem("marketername");
        var marketerid = sessionStorage.getItem("marketerid");
        if (marketername) {
            $('input[name="marketername"]').attr('placeholder', marketername);
        }

        //重置清除缓存
        $("button[type='reset']").on('click', function () {
            localStorage.removeItem("orderQuery");
            sessionStorage.removeItem("marketerid");
            sessionStorage.removeItem("marketername");
            sessionStorage.removeItem("searUserInfo");
            location.reload();
        });

        console.log(localStorage.getItem("queryIndex"));

        //自定义验证规则        form.verify({
        //自定义验证规则
        form.verify({
            idcard: function (value) {
                if (!value.match(/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/g)) {
                    return '身份证格式不正确';
                }
            },
            idcardaddress: function (value) { //身份证地址
                if (!value.match(/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,18}$/g)) {
                    return '用户名长度为6-18位数字+字母';
                }
            },
            tel: function (value) {
                if (!value.match(/13[0123456789]{1}\d{8}|14[5|7]\d{8}|15[12356789]\d{8}|18[0256789]\d{8}/g)) {
                    return '请输入正确的手机号';
                }
            }
        });
        //监听提交
        form.on('submit(submit)', function (data) {
            $(this).attr('disabled', "true");
            var productname = $("select[name='productid']").next().find("dd[class='layui-this']").html();
            var ordertype = localStorage.getItem("queryIndex");
            if (!ordertype) {
                ordertype = 0;
            }
            var dataArr = {
                "orderid": 0,
                "uid": data.field.downOrderUserid,
                "ordersource": 2,
                "ordertype": ordertype,
                "username": data.field.username,
                "uphonenumber": data.field.uphonenumber,
                "officearea": data.field.areaid,
                "fetchareaid": data.field.officearea,
                "officeaddress": data.field.officeaddress,
                "addressee": data.field.addressee,
                "productid": data.field.productid,
                "productname": productname,
                "aphonenumber": data.field.aphonenumber,
                "inboxarea": data.field.inboxarea,
                "inboxaddress": data.field.inboxaddress,
                "remarks": data.field.remarks,
                "idcardno": data.field.idcardno,
                "idcardaddress": data.field.idcardaddress,
                "passnumber": data.field.passnumber,
                "deliveryway": data.field.deliveryway, //邮寄方式
                "marketerid": marketerid,
                "marketername": marketername
            };
            var getJSON = common.getJsonData('api/bossApi/order/ordersEdit', '', dataArr);
            //console.log(dataArr);
            //console.log(getJSON);
            //return false;
            if (getJSON["code"] == 1) {
                layer.msg('操作成功', {icon: 1, time: 1500}, function () {
                    localStorage.removeItem("orderQuery");
                    sessionStorage.removeItem("marketerid");
                    sessionStorage.removeItem("marketername");
                    sessionStorage.removeItem("searUserInfo");
                    location.href = "index.html";
                    /*
                     var index = parent.layer.getFrameIndex(window.name);
                     parent.layer.close(index);
                     window.parent.location.reload();
                     */
                });
            } else {
                layer.msg(getJSON["msg"], {icon: 2, time: 1500}, function () {
                    $(".layui-btn").removeAttr('disabled');
                });
            }
            return false;
        });
        //搜索用户信息
        if (sessionStorage.getItem("searUserInfo")) {
            var getSearJSON = JSON.parse(sessionStorage.getItem("searUserInfo"));
            $("#lznumber").html(getSearJSON.datalist[0].lznumber);
            $("#phonenumer").html(getSearJSON.datalist[0].phonenumer);
            $("#nickname").html(getSearJSON.datalist[0].nickname);
            $("#address").html(getSearJSON.datalist[0].address);
            $("input[name='uphonenumber']").val(getSearJSON.datalist[0].phonenumer);
            $("input[name='downOrderUserid']").val(JSON.parse(sessionStorage.getItem("searUserInfo")).datalist[0].uid);
        }
        form.on('submit(searuser)', function (data) {
            var dataArr = {
                "text": $('input[name="title"]').val(),
                "page": 1
            }
            var getJSON = common.getJsonData('api/bossApi/order/ordersUserSearch', '', dataArr);
            sessionStorage.setItem("searUserInfo", JSON.stringify(getJSON));
            /*$("input[name='downOrderUserid']").val(JSON.parse(sessionStorage.getItem("searUserInfo")).datalist[0].uid);*/
            //console.log(sessionStorage.getItem("searUserInfo"))
            if (getJSON.datalist[0]) {
                $("#lznumber").html(getJSON.datalist[0].lznumber);
                $("#phonenumer").html(getJSON.datalist[0].phonenumer);
                $("#nickname").html(getJSON.datalist[0].nickname);
                $("#address").html(getJSON.datalist[0].address);
                $("input[name='uphonenumber']").val(getJSON.datalist[0].phonenumer);
                $("input[name='downOrderUserid']").val(getJSON.datalist[0].uid);
            } else {
                layer.msg('不存在该用户');
                $("#lznumber").html('');
                $("#phonenumer").html('');
                $("#nickname").html('');
                $("#address").html('');
                $("input[name='uphonenumber']").val('');
                $("input[name='downOrderUserid']").val('');
            }
            //console.log(getJSON.datalist[0]);
        });

    });
</script>
</body>
</html>
